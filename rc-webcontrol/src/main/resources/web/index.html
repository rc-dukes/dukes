<!DOCTYPE html>
<!--
  WebControl frontend
 -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Dukes Self driving RC-Car Webcontrol</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="sockjs.0.3.4.min.js"></script>
<script src="vertx-eventbus.js"></script>
<!--  Material Design Lite -->
<script src="md/material.min.js"></script>
<link rel="stylesheet" href="md/material.min.css">
<!--  Material design icons see https://materialdesignicons.com/getting-started -->
<link href="css/materialdesignicons.min.css" media="all"
	rel="stylesheet" type="text/css" />

<style type ="text /css">
body {
	background-attachment: scroll;
	background-clip: border-box;
	background-image: none;
	background-origin: padding-box;
	background-position: 0% 0%;
	background-repeat: repeat;
	background-size: auto auto;
	color: #212121;
	font-family: Arial, sans-serif;
	font-size: 14px;
	line-height: 20px;
	margin-bottom: 10px;
	margin-left: 10px;
	margin-right: 10px;
	margin-top: 10px;
	padding-bottom: 0px;
	padding-left: 0px;
	padding-right: 0px;
	padding-top: 0px;
}

table {
	border-collapse: collapse;
	color: #FFFFFF;
	font-family: Arial, sans-serif;
	font-size: 14px;
	line-height: 20px;
	margin-bottom: 0px;
	margin-left: 0px;
	margin-right: 0px;
	margin-top: 0px;
	overflow-x: auto;
}

tbody {
	border-collapse: collapse;
	color: #FFFFFF;
	font-family: Arial, sans-serif;
	font-size: 14px;
	line-height: 20px;
}

th {
	background-color: #3F51B5; /* PRIMARY COLOR */
	border-color: #303F9F;
	border-style: solid;
	border-width: 1px;
	border-collapse: collapse;
	color: #FFFFFF;
	font-family: Arial, sans-serif;
	font-size: 14px;
	font-weight: 700;
	line-height: 20px;
	padding-bottom: 7px;
	padding-left: 10px;
	padding-right: 10px;
	padding-top: 7px;
}

td {
	border-color: #303F9F;
	border-style: solid;
	border-width: 1px;
	border-collapse: collapse;
	color: black;
	font-family: Arial, sans-serif;
	font-size: 14px;
	line-height: 20px;
	padding-bottom: 7px;
	padding-left: 10px;
	padding-right: 10px;
	padding-top: 7px;
}

table.images {
	height: 550px;
	display: block;
}

img#cameraImage, img#linesImage, img#originalImage {
	height: 300px;
}

img#edgesImage, img#birdseyeImage {
	height: 150px;
}

td.controls {
	display: block;
	width: 450px;
}
/* material design Indigo
    https://www.materialpalette.com/indigo/indigo
    http://stackoverflow.com/questions/4069734/cross-browser-fixed-header-footer-and-scrollable-content
 */
#headerbox {
	background: #303F9F; /* DARK PRIMARY COLOR */
	color: #FFFFFF;
	padding: 2px;
	position: absolute;
	top: 0px;
	left: 0px;
	height: 32px;
	right: 0px;
	overflow: hidden;
}

#navigationbox {
	background: #3F51B5; /* PRIMARY COLOR */
	padding: 4px;
	color: #FFFFFF;
	font-size: 18px;
	position: absolute;
	top: 32px;
	left: 0px;
	height: 32px;
	right: 0px;
	overflow: hidden;
}

#footerbox {
	background: #303F9F; /* DARK PRIMARY COLOR */
	position: absolute;
	bottom: 0px;
	height: 24px;
	left: 0px;
	right: 0px;
	overflow: hidden;
}

#contentbox {
	position: absolute;
	top: 64px;
	bottom: 24px;
	left: 0px;
	right: 0px;
	background: white;
	overflow-y: scroll;
}

.headerboxicon {
	color: #FFFFFF;
	font-size: 24px;
}

.icon {
	color: #0000FF;
	font-size: 24px;
}

.bigicon {
	color: #0000FF;
	font-size: 64px;
}
</style>
</head>
<body>
	<div id='headerbox'>
		<a href='https://github.com/rc-dukes/dukes' title='Home'><i
			class='mdi mdi-home headerboxicon'></i> <!-- home --></a>
	</div>
	<div id='navigationbox' title='Self Driving RC Car WebControl'>Self
		Driving RC Car WebControl</div>
	<div id='contentbox'>
		<table id="navigationcontrols">
			<tr>
				<td></td>
				<td><i id="up" class='mdi mdi-arrow-up-bold bigicon'
					title="up/u" onclick="up();"></i></td>
				<td></td>
				<td><i id="autopilot" class='mdi mdi-car bigicon'
					title="autopilot/+" onclick="autopilot();"></i></td>
			</tr>
			<tr>
				<td><i id="left" class='mdi mdi-arrow-left-bold bigicon'
					title="left/l" onclick="left();"></i></td>
				<td><i id="stop" class='mdi mdi-stop bigicon'
					title="stop/space" onclick="stop();"></i></td>
				<td><i id="right" class='mdi mdi-arrow-right-bold bigicon'
					title="right/r" onclick="right();"></i></td>
				<td></td>	
			</tr>
			<tr>
				<td></td>
				<td><i id="down" class='mdi mdi-arrow-down-bold bigicon'
					title="down/d" onclick="down();"></i></td>
				<td></td>
				<td><i id="manual" class='mdi mdi-account bigicon'
					title="manual/-" onclick="manual();"></i></td>
			</tr>
			<tr>
			  <td><i id="brake" class='mdi mdi-close bigicon'
          title="brake/b/s" onclick="brake();"></i></td>
        <td><i id="center" class='mdi mdi-image-filter-center-focus bigicon' title='center/c/z' onclick="center();"></i></td>  
			</tr>
		</table>
		<h6>Events:</h6>
		<textarea id='events' cols="80" rows="3"></textarea>
		<table class="images">
			<tr>
				<td class="controls">
					<b>Canny config</b><br />
					Threshold 1: <input id="cannyConfigThreshold1Slider" value="60"
					type="range" min="0" max="500" step="1"
					oninput="onSlide('cannyConfigThreshold1Slider', 'cannyConfigThreshold1Textbox')" />
					<input id="cannyConfigThreshold1Textbox" size="2" /><br />

					Threshold 2: <input id="cannyConfigThreshold2Slider" value="150"
					type="range" min="0" max="500" step="1"
					oninput="onSlide('cannyConfigThreshold2Slider', 'cannyConfigThreshold2Textbox')" />
					<input id="cannyConfigThreshold2Textbox" size="2" /><br /> <br />
					<b>Hough config</b><br /> Rho: <input id="houghConfigRhoSlider"
					value="1" type="range" min="0.01" max="10" step="0.01"
					oninput="onSlide('houghConfigRhoSlider', 'houghConfigRhoTextbox')" />
					<input id="houghConfigRhoTextbox" size="2" /><br /> Theta: <input
					id="houghConfigThetaSlider" value="0.01745329251" type="range"
					min="0.01" max="0.2" step="0.00001"
					oninput="onSlide('houghConfigThetaSlider', 'houghConfigThetaTextbox')" />
					<input id="houghConfigThetaTextbox" size="8" /><br /> Threshold:
					<input id="houghConfigThresholdSlider" value="70" type="range"
					min="0" max="200" step="1"
					oninput="onSlide('houghConfigThresholdSlider', 'houghConfigThresholdTextbox')" />
					<input id="houghConfigThresholdTextbox" size="2" /><br />
					MinLineLength: <input id="houghConfigMinLineLengthSlider"
					value="20" type="range" min="0" max="200" step="1"
					oninput="onSlide('houghConfigMinLineLengthSlider', 'houghConfigMinLineLengthTextbox')" />
					<input id="houghConfigMinLineLengthTextbox" size="2" /><br />
					MaxLineGap: <input id="houghConfigMaxLineGapSlider" value="10"
					type="range" min="0" max="200" step="1"
					oninput="onSlide('houghConfigMaxLineGapSlider', 'houghConfigMaxLineGapTextbox')" />
					<input id="houghConfigMaxLineGapTextbox" size="2" /><br /> <br />
					<b>Camera config</b><br /> Exposure Comp. (-10...10), default 0: <input
					id="camEcSlider" value="0" type="range" min="-10" max="10" step="1"
					oninput="onSlideCam('camEcSlider', 'camEcTextbox', 'ec')" /> <input
					id="camEcTextbox" size="2" /><br /> Brightness (0...100), default
					50: <input id="camBrSlider" value="50" type="range" min="0"
					max="100" step="1"
					oninput="onSlideCam('camBrSlider', 'camBrTextbox', 'br')" /> <input
					id="camBrTextbox" size="2" /><br /> Saturation (-100...100),
					default 0: <input id="camSaSlider" value="0" type="range"
					min="-100" max="100" step="1"
					oninput="onSlideCam('camSaSlider', 'camSaTextbox', 'sa')" /> <input
					id="camSaTextbox" size="2" /><br /> <!--private double rho = 1;-->
					<!--private double theta = Math.PI/180; // By choosing this value lines sloping left to right will be < 0 radian, while lines sloping right to left will be > 0 radian.-->
					<!--private int threshold = 70;--> <!--private double minLineLength = 20;-->
					<!--private double maxLineGap = 10;-->
				</td>
				<td class="previewImage"><img id="originalImage"></td>
				<td class="previewImage"><img id="cameraImage"></td>
				<td class="previewImage"><img id="edgesImage"> <br /> <img
					id="birdseyeImage"></td>
				<td class="previewImage"><img id="linesImage"></td>
			</tr>
		</table>
		<!--<div id="message"></div>-->
		<!--<input type="file" accept="video/*"/>-->
		<!--<video controls autoplay></video>-->		
	</div>
	<!--  end of main content box -->
	<div id='footerbox'></div>
	<script type="text/javascript">
		// redirect console output
		// redirectConsole('console','','\n');
		// allow keyboard input
		registerControls();

		var eb = new EventBus("http://localhost:8080/eventbus");

		var NUM_LOG_LINES_VISIBLE = 15;
		var logLines = [];

		var display = function(err, msg) {
			var elem = document.getElementById("events");
			var logLine = new Date() + ' ' + JSON.stringify(msg.body);
			logLines.push(logLine);

			if (logLines.length > NUM_LOG_LINES_VISIBLE) {
				logLines = logLines.splice(-NUM_LOG_LINES_VISIBLE);
			}

			var allLogs = '';
			for (i = 0; i < logLines.length; i++) {
				allLogs += '\n' + logLines[i];
			}
			elem.innerText = allLogs;
		};

		eb.onopen = function() {
			eb.registerHandler("Lost sheep Bo", display);
			eb.registerHandler("Lost sheep Luke", display);
			eb.registerHandler("Bo Peep", display);
			eb.registerHandler("Shepherd", display);
			eb.registerHandler("Red Dog", display);
			// eb.registerHandler("Velvet ears", display);
			eb.registerHandler("Little fat buddy", display);
			eb.registerHandler("Crazy Cooter", display);
			eb.registerHandler("Dipstick", display);
			eb.registerHandler("Cletus", display);
			eb.registerHandler("STREAMADDED", function(err, msg) {
				var videoNode = document.querySelector('video');
				videoNode.src = "blob:" + msg.body.source;
			});
			eb.registerHandler("CANNYCONFIG", display);
			eb.registerHandler("HOUGHLINESCONFIG", display);
			eb.registerHandler("LANEDETECTION", display);
			eb.registerHandler("STARTLIGHTDETECTION", display);

			registerHeartBeat();
			registerDebugImages();
		}

		//            function localFileVideoPlayer() {
		//                'use strict'
		var URL = window.URL || window.webkitURL
		var displayMessage = function(message, isError) {
			var element = document.querySelector('#message')
			element.innerHTML = message;
			element.className = isError ? 'error' : 'info'
		};

		var playSelectedFile = function(event) {
			var file = this.files[0]
			var type = file.type
			var videoNode = document.querySelector('video')
			var canPlay = videoNode.canPlayType(type)
			if (canPlay === '')
				canPlay = 'no'
			var message = 'Can play type "' + type + '": ' + canPlay
			var isError = canPlay === 'no'
			displayMessage(message, isError)

			if (isError) {
				return
			}

			var fReader = new FileReader();
			fReader.readAsDataURL(file);
			fReader.onloadend = function(event) {

				var fileURL = URL.createObjectURL(file)
				eb.publish("STREAMADDED", {
					"source" : fileURL.replace(/blob:/, ''),
					"config" : {
						"interval" : 100
					}
				});
			};

			var inputNode = document.querySelector('input')

			inputNode.addEventListener('change', playSelectedFile, false)
		}

		function registerHeartBeat() {
			window.setInterval(sendHeartBeat, 150);
		}

		// register key handling controls
		function registerControls() {

			document.onkeydown = function(e) {
				e = e || window.event;

				// see
				// https://hacks.mozilla.org/2017/03/internationalize-your-keyboard-controls/
				// https://www.w3.org/TR/uievents-code/#code-value-tables
				var code = e.charCode;
				var key = e.key;
				if (code == 0) {
					code = e.keyCode;
				}
				console.log('keycode: ', code);
				console.log('key:', key);
				switch (key) {
				case 'ArrowLeft':
				case 'l':
					left(); // wheel left
					break;
				case 'ArrowRight':
				case 'r':
					right(); // wheel right
					break;
				case 'ArrowUp':
				case 'u':
					up(); // speed up
					break;
				case 'ArrowDown':
				case 'd':
					down(); // speed down
					break;
				case  ' ': // space
					stop(); // stop
					break;
				case 'b':
				case 's':
				  brake(); // brake
					break;
				case 'g':	
					// g: go
					sendSpeedDirectCommand("1");
				  break;
				case 'z':
				case 'c':
					center();
					break;
				case '+':
					// +: enable autopilot
					autopilot()
				  break;
				case '-':
					// -: disable autopilot
					manual();
				  break;
				} 
				// numeric key
				if (code >= 48 && code <= 58) {
					// 48: 1 key
					// 49: 2 key
					// set speed direct.
					speed = code - 48;
					sendSpeedDirectCommand(speed);
				}
			};
		}

		// https://stackoverflow.com/a/6604660/1497139
		// call e.g. with redirectConsole('debugDiv','<p>','</p>')
		function redirectConsole(consoleId, prefix, postfix) {
			if (typeof console != "undefined")
				if (typeof console.log != 'undefined')
					console.olog = console.log;
				else
					console.olog = function() {
					};

			console.log = function(message) {
				console.olog(message);
				document.getElementById(consoleId).innerHTML += prefix
						+ message + postfix;
			};
			console.error = console.debug = console.info = console.log
		}

		function up() {
			keyPressed("up");
			sendSpeedCommand('up');
		}

		function down() {
			keyPressed("down");
			sendSpeedCommand('down');
		}

		function left() {
			keyPressed("left");
			sendWheelCommand('left');
		}

		function right() {
			keyPressed("right");
			sendWheelCommand('right');
		}
		
		function center() {
	    // z/c: center wheel
	    keyPressed("center");
	    sendWheelCommand('center');
	 	}

		function stop() {
			keyPressed("stop");
			sendSpeedCommand('stop');
			sendWheelCommand('center');
		}

		function brake() {
		  // b / s: stop (with brake)
	    keyPressed("brake");
	    sendSpeedCommand('brake');
		}
		
		function autopilot() {
			keyPressed("autopilot");
			startAutoPilot();
		}

		function manual() {
			keyPressed("manual");
			stopAutoPilot();
		}

		function keyPressed(id) {
			console.log(id);
			var element = document.getElementById(id);
			element.style.fontWeight = 'bold';
			setTimeout(function() {
				element.style.fontWeight = 'normal';
			}, 200);
		}

		var CALLSIGN_BO = 'Lost sheep Bo';
		var CALLSIGN_DAISY = 'Bo Peep';

		function sendWheelCommand(position) {

			data = {
				type : 'servo',
				position : position
			};
			eb.publish(CALLSIGN_BO, data);
		}

		function sendSpeedCommand(speed) {
			data = {
				type : 'motor',
				speed : speed
			};
			eb.publish(CALLSIGN_BO, data);
		}

		function sendSpeedDirectCommand(speed) {
			data = {
				type : 'speedDirect',
				speed : '' + speed
			};
			eb.publish(CALLSIGN_BO, data);
		}

		var CALLSIGN_FLASH = "Velvet ears";
		function sendHeartBeat() {
			data = {
				type : 'heartbeat'
			};
			eb.publish(CALLSIGN_FLASH, data);
		}

		var CALLSIGN_LUKE = "Lost sheep Luke";
		function startAutoPilot() {
			eb.publish(CALLSIGN_LUKE + ':START_DRAG_NAVIGATION', undefined);
		}

		function stopAutoPilot() {
			eb.publish(CALLSIGN_LUKE + ':STOP_NAVIGATION', undefined);
		}

		function registerDebugImages() {
			window.setInterval(updateDebugImages, 100);
		}

		function updateDebugImages() {
			document.getElementById("originalImage").src = 'http://pibeewifi/html/cam_pic.php'; // 'http://localhost:8081?type=original&' + Math.random();
			document.getElementById("birdseyeImage").src = 'http://localhost:8081?type=birdseye&'
					+ Math.random();
			document.getElementById("edgesImage").src = 'http://localhost:8081?type=edges&'
					+ Math.random();
			document.getElementById("linesImage").src = 'http://localhost:8081?type=lines'
					+ Math.random();
		}

		function updateConfig() {
			var cannyConfigThreshold1 = document
					.getElementById('cannyConfigThreshold1Slider').value;
			var cannyConfigThreshold2 = document
					.getElementById('cannyConfigThreshold2Slider').value;

			cannyConfig = {};
			cannyConfig.threshold1 = Number(cannyConfigThreshold1);
			cannyConfig.threshold2 = Number(cannyConfigThreshold2);

			console.log('update canny config: ', cannyConfig);

			eb.publish(CALLSIGN_DAISY + ':CANNY_CONFIG_UPDATE', cannyConfig);

			var houghConfigRho = document
					.getElementById('houghConfigRhoSlider').value;
			var houghConfigTheta = document
					.getElementById('houghConfigThetaSlider').value;
			var houghConfigThreshold = document
					.getElementById('houghConfigThresholdSlider').value;
			var houghConfigMaxLineGap = document
					.getElementById('houghConfigMaxLineGapSlider').value;
			var houghConfigMinLineLength = document
					.getElementById('houghConfigMinLineLengthSlider').value;

			houghConfig = {};
			houghConfig.rho = Number(houghConfigRho);
			houghConfig.theta = Number(houghConfigTheta);
			houghConfig.threshold = Number(houghConfigThreshold);
			houghConfig.maxLineGap = Number(houghConfigMaxLineGap);
			houghConfig.minLineLength = Number(houghConfigMinLineLength);

			console.log('update hough config: ', houghConfig);
			eb.publish(CALLSIGN_DAISY + ':HOUGH_CONFIG_UPDATE', houghConfig);
		}

		function updateSliderValue(sliderId, textbox) {
			var x = document.getElementById(textbox);
			var y = document.getElementById(sliderId);
			x.value = y.value;
		}

		function onSlide(sliderId, textbox) {
			updateSliderValue(sliderId, textbox);
			updateConfig();
		}

		// set initial values for config
		updateSliderValue('cannyConfigThreshold1Slider',
				'cannyConfigThreshold1Textbox');
		updateSliderValue('cannyConfigThreshold2Slider',
				'cannyConfigThreshold2Textbox');
		updateSliderValue('houghConfigRhoSlider', 'houghConfigRhoTextbox');
		updateSliderValue('houghConfigThetaSlider', 'houghConfigThetaTextbox');
		updateSliderValue('houghConfigThresholdSlider',
				'houghConfigThresholdTextbox');
		updateSliderValue('houghConfigMinLineLengthSlider',
				'houghConfigMinLineLengthTextbox');
		updateSliderValue('houghConfigMaxLineGapSlider',
				'houghConfigMaxLineGapTextbox');
		updateSliderValue('houghConfigMaxLineGapSlider',
				'houghConfigMaxLineGapTextbox');

		// set initial values for cam config
		updateSliderValue('camEcSlider', 'camEcTextbox');
		updateSliderValue('camBrSlider', 'camBrTextbox');
		updateSliderValue('camSaSlider', 'camSaTextbox');

		function onSlideCam(sliderId, textbox, configKey) {
			updateSliderValue(sliderId, textbox);
			updateCamConfig(sliderId, configKey);
		}

		function updateCamConfig(elementId, configKey) {
			var configValue = document.getElementById(elementId).value;
			var url = 'http://10.9.8.7/html/cmd_pipe.php?cmd=' + configKey
					+ '%20' + configValue;

			var ajax_cmd = new XMLHttpRequest();
			ajax_cmd.open("GET", url, true);
			ajax_cmd.send();
		}

		//            setInterval(function() {
		//                document.getElementById("cameraImage").src='http://10.9.8.7/html/cam_get.php?timestamp=' + new Date();
		//            }, 50);
	</script>
</body>
</html>
