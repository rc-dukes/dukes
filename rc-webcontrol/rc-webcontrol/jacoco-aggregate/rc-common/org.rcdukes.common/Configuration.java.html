<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Configuration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">rc-webcontrol</a> &gt; <a href="../index.html" class="el_bundle">rc-common</a> &gt; <a href="index.source.html" class="el_package">org.rcdukes.common</a> &gt; <span class="el_source">Configuration.java</span></div><h1>Configuration.java</h1><pre class="source lang-java linenums">package org.rcdukes.common;

import java.io.File;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;

import org.apache.commons.io.FileUtils;
import org.apache.tinkerpop.gremlin.process.traversal.IO;
import org.apache.tinkerpop.gremlin.process.traversal.dsl.graph.GraphTraversalSource;
import org.apache.tinkerpop.gremlin.structure.Vertex;
import org.apache.tinkerpop.gremlin.tinkergraph.structure.TinkerGraph;

/**
 * configuration handler
 * 
 * @author wf
 *
 */
public class Configuration {

  private TinkerGraph graph;

<span class="nc" id="L25">  public static String STORE_MODE = IO.graphson;</span>
<span class="nc" id="L26">  public static String STORE_EXTENSION = &quot;.json&quot;;</span>
  private String graphFilePath;

  /**
   * @return the graphFilePath
   */
  public String getGraphFilePath() {
<span class="nc" id="L33">    return graphFilePath;</span>
  }

  /**
   * @param graphFilePath
   *          the graphFilePath to set
   */
  public void setGraphFilePath(String graphFilePath) {
<span class="nc" id="L41">    this.graphFilePath = graphFilePath;</span>
<span class="nc" id="L42">  }</span>

  /**
   * construct me
   */
<span class="nc" id="L47">  public Configuration(String graphFilePath, boolean readInis) {</span>
<span class="nc" id="L48">    this.graphFilePath = graphFilePath;</span>
<span class="nc" id="L49">    setGraph(TinkerGraph.open());</span>
<span class="nc" id="L50">    File graphFile = getGraphFile();</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">    if (readInis) {</span>
<span class="nc" id="L52">      fromIni();</span>
<span class="nc" id="L53">      write();</span>
    } else {
<span class="nc bnc" id="L55" title="All 2 branches missed.">      if (graphFile.exists()) {</span>
<span class="nc" id="L56">        read(graphFile);</span>
      }
    }
<span class="nc" id="L59">  }</span>

  /**
   * construct me
   */
  public Configuration() {
<span class="nc" id="L65">    this(Environment.dukesHome + &quot;config&quot; + STORE_EXTENSION, true);</span>
<span class="nc" id="L66">  }</span>

  /**
   * get my values from the &quot;*.ini&quot; property files in dukesHome
   */
  public void fromIni() {
<span class="nc" id="L72">    File dukesHome = new File(Environment.dukesHome);</span>
<span class="nc" id="L73">    String[] homeFiles = dukesHome.list();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">    for (String homeFile : homeFiles) {</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">      if (homeFile.endsWith(&quot;.ini&quot;)) {</span>
<span class="nc" id="L76">        String iniPath = dukesHome + &quot;/&quot; + homeFile;</span>
<span class="nc" id="L77">        Environment env = new Environment(iniPath);</span>
<span class="nc" id="L78">        this.addEnv(env);</span>
      }
    }
<span class="nc" id="L81">  }</span>

  public void addEnv(Environment env) {
    try {
<span class="nc" id="L85">      Vertex v = graph.addVertex(&quot;config&quot;);</span>
<span class="nc" id="L86">      v.property(&quot;inipath&quot;, env.propFilePath);</span>
<span class="nc" id="L87">      Properties lprops = env.getProperties();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">      for (Object keyo : lprops.keySet()) {</span>
<span class="nc" id="L89">        String key = keyo.toString();</span>
<span class="nc" id="L90">        String value = lprops.getProperty(key);</span>
<span class="nc" id="L91">        v.property(key, value);</span>
<span class="nc" id="L92">      }</span>
<span class="nc" id="L93">    } catch (Exception e) {</span>
      // bad luck
<span class="nc" id="L95">    }</span>
<span class="nc" id="L96">  }</span>

  public TinkerGraph getGraph() {
<span class="nc" id="L99">    return graph;</span>
  }

  public void setGraph(TinkerGraph graph) {
<span class="nc" id="L103">    this.graph = graph;</span>
<span class="nc" id="L104">  }</span>

  public GraphTraversalSource g() {
<span class="nc" id="L107">    return graph.traversal();</span>
  }

  /**
   * get the GraphFile
   * 
   * @return - the GraphFile
   */
  public File getGraphFile() {
<span class="nc" id="L116">    File graphFile = new File(getGraphFilePath());</span>
<span class="nc" id="L117">    return graphFile;</span>
  }

  /**
   * read my data from the given graphFile
   * 
   * @param graphFile
   */
  public void read(File graphFile) {
    // http://tinkerpop.apache.org/docs/3.4.0/reference/#io-step
<span class="nc" id="L127">    getGraph().traversal().io(graphFile.getPath()).with(IO.reader, STORE_MODE)</span>
<span class="nc" id="L128">        .read().iterate();</span>
<span class="nc" id="L129">  }</span>

  /**
   * write my data to the given graphFile
   * 
   * @param graphFile
   */
  public void write(File graphFile) {
    // http://tinkerpop.apache.org/docs/3.4.0/reference/#io-step
<span class="nc" id="L138">    getGraph().traversal().io(graphFile.getPath()).with(IO.writer, STORE_MODE)</span>
<span class="nc" id="L139">        .write().iterate();</span>
<span class="nc" id="L140">  }</span>

  public String asString() throws Exception {
<span class="nc" id="L143">    String text = FileUtils.readFileToString(getGraphFile(), &quot;utf-8&quot;);</span>
<span class="nc" id="L144">    return text;</span>
  }

  /**
   * get the environments
   * @return
   * @throws Exception
   */
  public Map&lt;String, Environment&gt; getEnvironments()  {
<span class="nc" id="L153">    Map&lt;String, Environment&gt; envMap = new HashMap&lt;String, Environment&gt;();</span>
<span class="nc" id="L154">    List&lt;Vertex&gt; envNodes = g().V().has(Config.REMOTECAR_HOST).toList();</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">    for (Vertex envNode : envNodes) {</span>
<span class="nc" id="L156">      Environment env=getEnvironmentFromVertex(envNode);</span>
      try {
<span class="nc" id="L158">        envMap.put(env.getString(Config.REMOTECAR_HOST),env);</span>
<span class="nc" id="L159">      } catch (Exception e) {</span>
        // bad luck
<span class="nc" id="L161">      }</span>
<span class="nc" id="L162">    }</span>
<span class="nc" id="L163">    return envMap;</span>
  }
  
  public Environment getEnvironmentFromVertex(Vertex v) {
<span class="nc" id="L167">    Environment env=new Environment(null);</span>
<span class="nc" id="L168">    env.props=new Properties();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">    for (String key : v.keys()) {</span>
<span class="nc" id="L170">      env.props.put(key, v.property(key).value());</span>
<span class="nc" id="L171">    }</span>
<span class="nc" id="L172">    return env;</span>
  }

  /**
   * write me
   */
  public void write() {
<span class="nc" id="L179">    File graphFile = getGraphFile();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">    if (!graphFile.getParentFile().exists()) {</span>
<span class="nc" id="L181">      graphFile.getParentFile().mkdirs();</span>
    }
<span class="nc" id="L183">    write(graphFile);</span>
<span class="nc" id="L184">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>