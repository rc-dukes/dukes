<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Detector.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">rc-imageview</a> &gt; <a href="../index.html" class="el_bundle">rc-detect</a> &gt; <a href="index.source.html" class="el_package">org.rcdukes.detect</a> &gt; <span class="el_source">Detector.java</span></div><h1>Detector.java</h1><pre class="source lang-java linenums">package org.rcdukes.detect;

import java.util.concurrent.TimeUnit;

import org.rcdukes.camera.CameraMatrix;
import org.rcdukes.common.Characters;
import org.rcdukes.common.DukesVerticle;
import org.rcdukes.common.Events;
import org.rcdukes.detect.edgedectection.CannyEdgeDetector;
import org.rcdukes.detect.linedetection.HoughLinesLineDetector;
import org.rcdukes.detectors.EdgeDetector;
import org.rcdukes.detectors.LineDetector;
import org.rcdukes.geometry.LaneDetectionResult;
import org.rcdukes.opencv.NativeLibrary;
import org.rcdukes.video.ImageCollector;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import io.reactivex.Observable;
import io.reactivex.disposables.Disposable;
import io.reactivex.schedulers.Schedulers;
import io.vertx.core.json.JsonObject;
import io.vertx.rxjava.core.eventbus.Message;

/**
 * Detector aka Daisy
 */
public class Detector extends DukesVerticle {

  // @FIXME - does not belong here ...
  private final static long START_LIGHT_DETECTION_INTERVAL = 50;
<span class="nc" id="L33">  private static ImageCollector currentCollector = new ImageCollector();</span>

  public static synchronized ImageCollector getImageCollector() {
<span class="nc" id="L36">    return currentCollector;</span>
  }

 
  private ImageFetcher fetcher;
  private Disposable startLaneDetectionSubscription;
  private Disposable startLightDetectionSubscription;

  /**
   * default constructor
   */
  public Detector() {
<span class="nc" id="L48">    super(Characters.DAISY);</span>
<span class="nc" id="L49">  }</span>

  @Override
  public void start() throws Exception {
<span class="nc" id="L53">    super.preStart();</span>
<span class="nc" id="L54">    NativeLibrary.load();</span>
    // register vert.x event handlers
<span class="nc" id="L56">    consumer(Events.START_LANE_DETECTION,</span>
        this::startLaneDetectionMessageHandler);
    // consumer(Events.START_STARTLIGHT_DETECTION, this::startSLD); - blocking issue ..
<span class="nc" id="L59">    consumer(Events.CAMERA_CONFIG_UPDATE, this::cameraConfig);</span>
<span class="nc" id="L60">    consumer(Events.CANNY_CONFIG_UPDATE, this::cannyConfig);</span>
<span class="nc" id="L61">    consumer(Events.HOUGH_CONFIG_UPDATE, this::houghConfig);</span>
<span class="nc" id="L62">    consumer(Events.CAMERA_MATRIX_UPDATE, this::cameraMatrix);</span>
<span class="nc" id="L63">    super.postStart();</span>
<span class="nc" id="L64">  }</span>

  /**
   * start Lane Detection
   * 
   * @param message
   */
  private void startLaneDetectionMessageHandler(Message&lt;JsonObject&gt; message) {
<span class="nc" id="L72">    JsonObject jo = message.body();</span>
<span class="nc" id="L73">    CameraConfig cameraConfig = super.fromJsonObject(jo, CameraConfig.class);</span>
    // is this a restart?
<span class="nc bnc" id="L75" title="All 2 branches missed.">    if (startLaneDetectionSubscription != null)</span>
<span class="nc" id="L76">      startLaneDetectionSubscription.dispose();;</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">    if (fetcher!=null)</span>
<span class="nc" id="L78">      fetcher.close();</span>
<span class="nc" id="L79">    startLaneDetectionSubscription = startLaneDetection(cameraConfig)</span>
        // .doOnNext(detection -&gt; LOG.trace(&quot;Image lane detection processing
        // result: &quot; + detection))
<span class="nc" id="L82">        .subscribe(</span>
            lane -&gt; {
<span class="nc" id="L84">              JsonObject laneJo=JsonObject.mapFrom(lane);</span>
<span class="nc" id="L85">              super.sendEvent(Characters.LUKE, Events.LANE_DETECTED, laneJo);</span>
<span class="nc" id="L86">            },</span>
<span class="nc" id="L87">            error -&gt; LOG.error(&quot;Error during lane detection image processing:&quot;,</span>
                error),
<span class="nc" id="L89">            () -&gt; LOG.info(&quot;Lane detection image processing ended&quot;));</span>
<span class="nc" id="L90">  }</span>

  private void startSLD(Message&lt;JsonObject&gt; message) {
    // is this a restart?
<span class="nc bnc" id="L94" title="All 2 branches missed.">    if (startLightDetectionSubscription != null)</span>
<span class="nc" id="L95">      startLightDetectionSubscription.dispose();;</span>
<span class="nc" id="L96">    startLightDetectionSubscription = startStartLightDetection(message)</span>
        // .doOnNext(detection -&gt; LOG.trace(&quot;Image start light processing
        // result: &quot; + detection))
        // .takeWhile()
<span class="nc" id="L100">        .subscribe(</span>
<span class="nc" id="L101">            light -&gt; vertx.eventBus()</span>
<span class="nc" id="L102">                .publish(Events.START_STARTLIGHT_DETECTION.name(), light),</span>
<span class="nc" id="L103">            error -&gt; LOG.error(&quot;Error during start light image processing:&quot;,</span>
                error),
<span class="nc" id="L105">            () -&gt; LOG.info(&quot;Start light image processing ended&quot;));</span>
<span class="nc" id="L106">  }</span>

  private void cameraConfig(Message&lt;JsonObject&gt; message) {
<span class="nc" id="L109">    JsonObject jo = message.body();</span>
<span class="nc" id="L110">    JsonObject currentJo = this.getSharedData(&quot;cameraConfig&quot;);</span>
<span class="nc" id="L111">    boolean restart = false;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">    if (currentJo == null) {</span>
<span class="nc" id="L113">      restart = true;</span>
    } else {
<span class="nc" id="L115">      CameraConfig currentCameraConfig = currentJo.mapTo(CameraConfig.class);</span>
<span class="nc" id="L116">      CameraConfig cameraConfig = jo.mapTo(CameraConfig.class);</span>
<span class="nc" id="L117">      restart = !cameraConfig.getSource()</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">          .equals(currentCameraConfig.getSource());</span>
    }
    // update the camera Configuration
<span class="nc" id="L121">    shareData(&quot;cameraConfig&quot;, jo);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">    if (restart) {</span>
<span class="nc" id="L123">      sendEvent(this.character,Events.START_LANE_DETECTION, jo);</span>
<span class="nc" id="L124">      sendEvent(this.character,Events.START_STARTLIGHT_DETECTION, jo);</span>
    }
<span class="nc" id="L126">  }</span>

  private void cannyConfig(Message&lt;JsonObject&gt; message) {
<span class="nc" id="L129">    shareData(&quot;canny&quot;, message.body());</span>
<span class="nc" id="L130">  }</span>

  private void houghConfig(Message&lt;JsonObject&gt; message) {
<span class="nc" id="L133">    shareData(&quot;hough&quot;, message.body());</span>
<span class="nc" id="L134">  }</span>

  private void cameraMatrix(Message&lt;JsonObject&gt; message) {
<span class="nc" id="L137">    shareData(&quot;matrix&quot;, message.body());</span>
<span class="nc" id="L138">  }</span>

  private CameraMatrix createMatrix() {
<span class="nc" id="L141">    String matrix = (String) vertx.sharedData()</span>
<span class="nc" id="L142">        .getLocalMap(Characters.DAISY.name()).get(&quot;matrix&quot;);</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">    return matrix != null</span>
<span class="nc" id="L145">        ? CameraMatrix.deserizalize((String) vertx.sharedData()</span>
<span class="nc" id="L146">            .getLocalMap(Characters.DAISY.name()).get(&quot;matrix&quot;))</span>
        : CameraMatrix.DEFAULT;
  }

  /**
   * start the lane detection based on the given message
   * 
   * @param msg
   * @return
   **/
  private Observable&lt;LaneDetectionResult&gt; startLaneDetection(CameraConfig cameraConfig) {
<span class="nc" id="L157">    return startLaneDetectionObservable(cameraConfig).map(ldr -&gt; ldr);</span>
  }

  /**
   * startLaneDetectionObservable
   * 
   * @param cameraConfig
   * @return
   */
  private Observable&lt;LaneDetectionResult&gt; startLaneDetectionObservable(
      CameraConfig cameraConfig) {
<span class="nc" id="L168">    fetcher = new ImageFetcher(cameraConfig.getSource());</span>
<span class="nc" id="L169">    fetcher.setFps(cameraConfig.getFps());</span>

<span class="nc" id="L171">    LOG.info(</span>
<span class="nc" id="L172">        &quot;Started image processing for source: &quot; + cameraConfig.getSource());</span>
<span class="nc" id="L173">    return fetcher.toObservable().subscribeOn(Schedulers.newThread())</span>
<span class="nc" id="L174">        .throttleFirst(cameraConfig.getInterval(), TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L175">        .map(image -&gt; {</span>
<span class="nc" id="L176">          currentCollector = new ImageCollector();</span>
<span class="nc" id="L177">          EdgeDetector edgeDetector = super.getSharedPojo(&quot;canny&quot;,</span>
              CannyEdgeDetector.class);
<span class="nc" id="L179">          LineDetector lineDetector = super.getSharedPojo(&quot;hough&quot;,</span>
              HoughLinesLineDetector.class);
<span class="nc" id="L181">          CameraConfig updatedCameraConfig = super.getSharedPojo(&quot;cameraConfig&quot;,</span>
              CameraConfig.class);
<span class="nc" id="L183">          LaneDetectionResult detection = new LaneDetector(edgeDetector,</span>
<span class="nc" id="L184">              lineDetector, updatedCameraConfig, createMatrix(),</span>
<span class="nc" id="L185">              currentCollector).detect(image);</span>
<span class="nc" id="L186">          return detection;</span>
        });
  }

  private Observable startStartLightDetection(Message&lt;JsonObject&gt; msg) {
<span class="nc" id="L191">    JsonObject jo = msg.body();</span>
<span class="nc" id="L192">    JsonObject config = jo.getJsonObject(&quot;config&quot;);</span>

<span class="nc" id="L194">    long interval = START_LIGHT_DETECTION_INTERVAL;</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">    if (config != null) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">      if (config.containsKey(&quot;interval&quot;)) {</span>
<span class="nc" id="L197">        interval = config.getLong(&quot;interval&quot;);</span>
      }
    }

<span class="nc" id="L201">    StartLightDetectorImpl.Config config1 = new StartLightDetectorImpl.Config();</span>
<span class="nc" id="L202">    StartLightDetectorImpl startLightDetector = new StartLightDetectorImpl(</span>
        config1);

    // @FIXME - don't create multiple image fetchers
<span class="nc" id="L206">    ImageFetcher fetcher = new ImageFetcher(jo.getString(&quot;source&quot;));</span>

<span class="nc" id="L208">    return fetcher.toObservable().sample(interval, TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L209">        .map(startLightDetector::detect).map(map -&gt; {</span>
          try {
<span class="nc" id="L211">            return new ObjectMapper().writeValueAsString(map);</span>
<span class="nc" id="L212">          } catch (JsonProcessingException e) {</span>
<span class="nc" id="L213">            throw new RuntimeException(e);</span>
          }
        });
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>