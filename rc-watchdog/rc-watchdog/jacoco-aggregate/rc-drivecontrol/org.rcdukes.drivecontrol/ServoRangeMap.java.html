<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ServoRangeMap.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">rc-watchdog</a> &gt; <a href="../index.html" class="el_bundle">rc-drivecontrol</a> &gt; <a href="index.source.html" class="el_package">org.rcdukes.drivecontrol</a> &gt; <span class="el_source">ServoRangeMap.java</span></div><h1>ServoRangeMap.java</h1><pre class="source lang-java linenums">package org.rcdukes.drivecontrol;

import org.rcdukes.car.ServoRange;
import org.rcdukes.car.ServoSide;
import org.rcdukes.common.ServoPosition;

/**
 * a range map
 * 
 * @author wf
 *
 */
<span class="nc bnc" id="L13" title="All 2 branches missed.">public abstract class ServoRangeMap extends ServoMap</span>
    implements org.rcdukes.car.ServoRangeMap {
<span class="nc" id="L15">  private ServoRange range = null;</span>

  private String unit;
  private String name;

  public ServoRange getRange() {
<span class="nc" id="L21">    return range;</span>
  }

  public void setRange(ServoRange range) {
<span class="nc bnc" id="L25" title="All 2 branches missed.">    if (this.range == null)</span>
<span class="nc" id="L26">      this.newPosition(range.getZeroPosition());</span>
<span class="nc" id="L27">    this.range = range;</span>
<span class="nc" id="L28">  }</span>

  public String getUnit() {
<span class="nc" id="L31">    return unit;</span>
  }

  public void setUnit(String unit) {
<span class="nc" id="L35">    this.unit = unit;</span>
<span class="nc" id="L36">  }</span>

  public String getName() {
<span class="nc" id="L39">    return name;</span>
  }

  public void setName(String name) {
<span class="nc" id="L43">    this.name = name;</span>
<span class="nc" id="L44">  }</span>

  @Override
  public ServoPosition atPercent(double percent) {
<span class="nc" id="L48">    ServoRange range = this.getRange();</span>
<span class="nc" id="L49">    ServoSide n = range.getSideN();</span>
<span class="nc" id="L50">    ServoSide p = range.getSideP();</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">    if (percent == 0)</span>
<span class="nc" id="L52">      return range.getZeroPosition();</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">    else if (percent &lt; 0) {</span>
<span class="nc" id="L54">      return n.interpolate(percent);</span>
    } else {
<span class="nc" id="L56">      return p.interpolate(percent);</span>
    }
  }

  @Override
  public ServoPosition atValue(double value) {
<span class="nc" id="L62">    double percent=0.;</span>
<span class="nc" id="L63">    ServoSide sideN = range.getSideN();</span>
<span class="nc" id="L64">    ServoSide sideP = range.getSideP();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">    if (value&lt;0) {</span>
<span class="nc" id="L66">      percent=value/sideN.valueRange()*100;</span>
    } else {
<span class="nc" id="L68">      percent=value/sideP.valueRange()*100;</span>
    }
<span class="nc" id="L70">    return this.atPercent(percent);</span>
  }

  @Override
  public void step(int servoStep) {
<span class="nc" id="L75">    int spos = this.currentPosition.getServoPos();</span>
<span class="nc" id="L76">    spos += servoStep * range.getStepSize();</span>
<span class="nc" id="L77">    spos = this.range.clampServoPos(spos);</span>
<span class="nc" id="L78">    double value = 0;</span>
<span class="nc" id="L79">    ServoSide side = null;</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">    if (range.getSideN().isServoPosOnSide(spos)) {</span>
<span class="nc" id="L81">      side = range.getSideN();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">    } else if (range.getSideP().isServoPosOnSide(spos)) {</span>
<span class="nc" id="L83">      side = range.getSideP();</span>
    }
<span class="nc bnc" id="L85" title="All 2 branches missed.">    if (side != null) {</span>
<span class="nc" id="L86">      value = side.interpolateValueFromPos(spos);</span>
    }
<span class="nc" id="L88">    this.currentPosition.setServoPos(spos);</span>
<span class="nc" id="L89">    this.currentPosition.setValue(value);</span>
<span class="nc" id="L90">  }</span>

  /**
   * set a new Position
   * 
   * @param newPosition
   */
  @Override
  public ServoPosition newPosition(ServoPosition newPosition) {
<span class="nc" id="L99">    newPosition = super.newPosition(newPosition);</span>
<span class="nc" id="L100">    newPosition.unit = unit;</span>
<span class="nc" id="L101">    return newPosition;</span>
  }

  @Override
  public void setZero() {
<span class="nc" id="L106">    this.newPosition(range.getZeroPosition());</span>
<span class="nc" id="L107">  }</span>

  /**
   * return the given position info
   * 
   * @return the position info
   */
  public String positionInfo() {
<span class="nc" id="L115">    String info = this.currentPosition.toString();</span>
<span class="nc" id="L116">    return info;</span>
  }

  protected void assertGreater(double vmax, double vmin, String maxname,
      String minname) throws Exception {
    boolean ok;
<span class="nc" id="L122">    String cmp = &quot;&quot;;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    ok = (vmax &lt; vmin);</span>
<span class="nc" id="L124">    cmp = &quot;&gt;=&quot;;</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">    if (ok) {</span>
<span class="nc" id="L126">      String msg = String.format(&quot;%s %f should be %s than %s %f&quot;, maxname, vmax,</span>
<span class="nc" id="L127">          cmp, minname, vmin);</span>
<span class="nc" id="L128">      throw new Exception(msg);</span>
    }
<span class="nc" id="L130">  }</span>

  protected void checkSide(ServoSide side) throws Exception {
<span class="nc" id="L133">    assertGreater(side.getMax().getValue(), side.getMin().getValue(),</span>
<span class="nc" id="L134">        side.getMax().valueConfig, side.getMin().valueConfig);</span>
<span class="nc" id="L135">    assertGreater(side.getMax().getServoPos(), side.getMin().getServoPos(),</span>
<span class="nc" id="L136">        side.getMax().servoConfig, side.getMin().valueConfig);</span>
<span class="nc" id="L137">  }</span>

  /**
   * check the validity of this servoMap
   * 
   * @throws Exception
   */
  protected void check() throws Exception {
<span class="nc" id="L145">    range = this.getRange();</span>
<span class="nc" id="L146">    LOG.info(String.format(</span>
        &quot;%s gpio: %s  %3d - %3d &gt; %3d &lt; %3d - %3d orientation: %s steps:  %3d&quot;,
<span class="nc" id="L148">        name, this.gpioPin, range.getSideN().getMin().getServoPos(),</span>
<span class="nc" id="L149">        range.getSideN().getMax().getServoPos(),</span>
<span class="nc" id="L150">        range.getZeroPosition().getServoPos(),</span>
<span class="nc" id="L151">        range.getSideP().getMin().getServoPos(),</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        range.getSideP().getMax().getServoPos(),</span>
<span class="nc" id="L153">        this.turnedOrientation ? &quot;-&quot; : &quot;+&quot;, range.getStepSize()));</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">    assert range.getStepSize() &gt; 0 : &quot;step size should be &gt;0&quot;;</span>
<span class="nc" id="L155">    ServoSide sideN = range.getSideN();</span>
<span class="nc" id="L156">    ServoSide sideP = range.getSideP();</span>
<span class="nc" id="L157">    checkSide(sideN);</span>
<span class="nc" id="L158">    checkSide(sideP);</span>
<span class="nc" id="L159">  }</span>

  /**
   * switch the sides
   */
  public void configureOrientation() {
<span class="nc bnc" id="L165" title="All 2 branches missed.">    if (this.turnedOrientation) {</span>
<span class="nc" id="L166">      ServoSide n = range.getSideP();</span>
<span class="nc" id="L167">      ServoSide p = range.getSideN();</span>
<span class="nc" id="L168">      range.setSideN(n);</span>
<span class="nc" id="L169">      range.setSideP(p);</span>
    }
<span class="nc" id="L171">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>