<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Environment.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">rc-remotecar</a> &gt; <a href="../index.html" class="el_bundle">rc-common</a> &gt; <a href="index.source.html" class="el_package">org.rcdukes.common</a> &gt; <span class="el_source">Environment.java</span></div><h1>Environment.java</h1><pre class="source lang-java linenums">package org.rcdukes.common;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStreamReader;
import java.net.InetAddress;
import java.net.NetworkInterface;
import java.net.SocketException;
import java.nio.charset.Charset;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Properties;
import java.util.stream.Collectors;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import io.vertx.core.json.JsonObject;

/**
 * allows to get ip address of raspberry and find out whether we run on a
 * raspberry see
 * &lt;a href='https://stackoverflow.com/a/54304350/1497139'&gt;Stackoverflow
 * question&lt;/a&gt; supply service url for camera
 * 
 * @author wf
 *
 */
public class Environment {

<span class="nc" id="L33">  private static final Logger LOG = LoggerFactory.getLogger(Environment.class);</span>
<span class="nc" id="L34">  public static String dukesHome = System.getProperty(&quot;user.home&quot;) + &quot;/.dukes/&quot;;</span>
<span class="nc" id="L35">  public String propFilePath = dukesHome + &quot;dukes.ini&quot;;</span>

  private static Environment instance;
  private boolean runningOnRaspberryPi;

  Properties props;

  /**
   * read the first line from the given file
   * 
   * @param file
   *          - the file to read
   * @return the first line
   */
  public static String readFirstLine(File file) {
<span class="nc" id="L50">    String firstLine = null;</span>
    try {
<span class="nc bnc" id="L52" title="All 2 branches missed.">      if (file.canRead()) {</span>
<span class="nc" id="L53">        FileInputStream fis = new FileInputStream(file);</span>
<span class="nc" id="L54">        BufferedReader bufferedReader = new BufferedReader(</span>
            new InputStreamReader(fis));
<span class="nc" id="L56">        firstLine = bufferedReader.readLine();</span>
<span class="nc" id="L57">        fis.close();</span>
      }
<span class="nc" id="L59">    } catch (Throwable th) {</span>
<span class="nc" id="L60">      LOG.error(th.getMessage());</span>
      // th.printStackTrace();
<span class="nc" id="L62">    }</span>
<span class="nc" id="L63">    return firstLine;</span>
  }

  /**
   * get the operating System release
   * 
   * @return the first line from /etc/os-release or null
   */
  public static String osRelease() {
<span class="nc" id="L72">    String os = System.getProperty(&quot;os.name&quot;);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">    if (os.startsWith(&quot;Linux&quot;)) {</span>
<span class="nc" id="L74">      final File osRelease = new File(&quot;/etc&quot;, &quot;os-release&quot;);</span>
<span class="nc" id="L75">      return readFirstLine(osRelease);</span>
    }
<span class="nc" id="L77">    return null;</span>
  }

  /**
   * check if this java vm runs on a raspberry PI
   * https://stackoverflow.com/questions/37053271/the-ideal-way-to-detect-a-raspberry-pi-from-java-jar
   * 
   * @return true if this is running on a Raspbian Linux
   */
  public boolean isPi() {
<span class="nc" id="L87">    String osRelease = osRelease();</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">    return osRelease != null &amp;&amp; osRelease.contains(&quot;Raspbian&quot;);</span>
  }

  // do not externally instantiate with out params
<span class="nc" id="L92">  private Environment() {</span>
<span class="nc" id="L93">    runningOnRaspberryPi = isPi(); // getMyIpAddresses().contains(RASPBERRY_PI_IP);</span>
<span class="nc" id="L94">  }</span>

  /**
   * configure me from the given propertyFile Path
   * 
   * @param propFilePath
   */
  public Environment(String propFilePath) {
<span class="nc" id="L102">    this();</span>
<span class="nc" id="L103">    this.propFilePath = propFilePath;</span>
<span class="nc" id="L104">  }</span>

  /**
   * singleton
   * 
   * @return the singleton
   */
  public static Environment getInstance() {
<span class="nc bnc" id="L112" title="All 2 branches missed.">    if (instance == null) {</span>
<span class="nc" id="L113">      instance = new Environment();</span>
    }
<span class="nc" id="L115">    return instance;</span>
  }

  /**
   * are we running on the raspberry?
   * 
   * @return true if so
   */
  public boolean runningOnRaspberryPi() {
<span class="nc" id="L124">    return runningOnRaspberryPi;</span>
  }

  /**
   * get the properties from the given path
   * 
   * @return - the properties
   * @throws Exception
   *           if propfile can't be read
   */
  public Properties getProperties() throws Exception {
<span class="nc bnc" id="L135" title="All 2 branches missed.">    if (props == null) {</span>
<span class="nc" id="L136">      File propFile = new File(propFilePath);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">      if (!propFile.canRead()) {</span>
<span class="nc" id="L138">        throw new Exception(</span>
<span class="nc" id="L139">            &quot;missing property file &quot; + propFile.getAbsolutePath());</span>
      }
<span class="nc" id="L141">      props = new Properties();</span>
<span class="nc" id="L142">      FileInputStream input = new FileInputStream(propFile);</span>
<span class="nc" id="L143">      props.load(new InputStreamReader(input, Charset.forName(&quot;UTF-8&quot;)));</span>
    }
<span class="nc" id="L145">    return props;</span>
  }

  /**
   * return me as a json object
   * 
   * @return the configuration properties as a single json object
   * @throws Exception
   */
  public JsonObject asJsonObject() throws Exception {
<span class="nc" id="L155">    Properties lprops = getProperties();</span>
<span class="nc" id="L156">    JsonObject json = new JsonObject();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">    for (Object keyo : lprops.keySet()) {</span>
<span class="nc" id="L158">      String key = keyo.toString();</span>
<span class="nc" id="L159">      json.put(key, lprops.getProperty(key));</span>
<span class="nc" id="L160">    }</span>
<span class="nc" id="L161">    return json;</span>
  }

  /**
   * set a new environment from the given json object
   * 
   * @param configJo
   */
  public static void from(JsonObject configJo) {
<span class="nc" id="L170">    Environment.reset();</span>
<span class="nc" id="L171">    Environment env = Environment.getInstance();</span>
<span class="nc" id="L172">    env.props = new Properties();</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">    for (String key:configJo.fieldNames()) {</span>
<span class="nc" id="L174">      env.props.put(key, configJo.getValue(key));</span>
<span class="nc" id="L175">    }</span>
<span class="nc" id="L176">  }</span>

  /**
   * get my ip addresses
   * 
   * @return - my ip addresses
   */
  public List&lt;String&gt; getMyIpAddresses() {
    try {
<span class="nc" id="L185">      return Collections.list(NetworkInterface.getNetworkInterfaces()).stream()</span>
<span class="nc" id="L186">          .map(iface -&gt; Collections.list(iface.getInetAddresses()))</span>
<span class="nc" id="L187">          .flatMap(Collection::stream).map(InetAddress::getHostAddress)</span>
<span class="nc" id="L188">          .collect(Collectors.toList());</span>
<span class="nc" id="L189">    } catch (SocketException e) {</span>
<span class="nc" id="L190">      LOG.error(&quot;Error while determining IP addresses: &quot;, e);</span>
<span class="nc" id="L191">      return null;</span>
    }
  }

  /**
   * get the property value for the given key
   * 
   * @param key
   * @return - the string value for the given property key
   * @throws Exception
   */
  public String getString(String key) throws Exception {
<span class="nc" id="L203">    Object prop = this.getProperties().get(key);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">    if (prop == null)</span>
<span class="nc" id="L205">      throw new IllegalArgumentException(</span>
          &quot;Property &quot; + key + &quot; is not configured in &quot; + propFilePath);
<span class="nc" id="L207">    String value = prop.toString();</span>
<span class="nc" id="L208">    return value;</span>
  }

  /**
   * get an integer property with the given key
   * 
   * @param key
   * @return - the property value
   * @throws Exception
   */
  public int getInteger(String key) throws Exception {
<span class="nc bnc" id="L219" title="All 2 branches missed.">    if (Config.ZERO.equals(key))</span>
<span class="nc" id="L220">      return 0;</span>
<span class="nc" id="L221">    String valueStr = this.getString(key);</span>
<span class="nc" id="L222">    int value = Integer.parseInt(valueStr);</span>
<span class="nc" id="L223">    return value;</span>
  }
  
  /**
   * get a double property with the given key
   * @param key
   * @return the double property
   * @throws Exception
   */
  public double getDouble(String key) throws Exception {
<span class="nc bnc" id="L233" title="All 2 branches missed.">    if (Config.ZERO.equals(key))</span>
<span class="nc" id="L234">      return 0.0;</span>
<span class="nc" id="L235">    String valueStr=this.getString(key);</span>
<span class="nc" id="L236">    double value=Double.parseDouble(valueStr);</span>
<span class="nc" id="L237">    return value;</span>
  }

  /**
   * reset my singleton
   */
  public static void reset() {
<span class="nc" id="L244">    instance = null;</span>
<span class="nc" id="L245">  }</span>

  /**
   * get the current environment from the given path
   * 
   * @param propFilePath
   */
  public static void from(String propFilePath) {
    // Let's fake a configuration
<span class="nc" id="L254">    Environment.reset();</span>
<span class="nc" id="L255">    Environment env = Environment.getInstance();</span>
<span class="nc" id="L256">    env.propFilePath = propFilePath;</span>
<span class="nc" id="L257">  }</span>

  /**
   * mock a test enviroment
   */
  public static void mock() {
<span class="nc" id="L263">    Environment.from(&quot;../rc-drivecontrol/src/test/resources/dukes/dukes.ini&quot;);</span>
<span class="nc" id="L264">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>